<!DOCTYPE HTML>
<html lang="en">

<head>
    <title>Test Data Table</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css"
        integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz" crossorigin="anonymous">
    <script src="src/test-files.js"></script>
    <script src="//localhost:35750/livereload.js"></script>

    <style>
        html,
        body {
            height: 100%;
        }

        body {
            padding: 20px;
            font-family: sans-serif;
        }

        section {
            border: 1px solid #ccc;
            padding: 3px;
            margin: 5px;
        }

        section label {
            display: block;
            padding: 5px;
        }

        .sized {
            height: 300px;
        }
    </style>
</head>

<body>
    <h1>Test Data Table</h1>

    <div id="mocha"></div>
    <div id="tests"></div>

    <script>
        window.mocha.setup('bdd');
        window.mocha.options.allowUncaught = true;


        function createSchema(options) {
            return {
                name: 'Name',
                age: 'Age',
                height: 'Height',
                weight: 'Weight',
                bp: 'Bloodpressure'
            }
        }
        describe('DataTable', function () {
            this.timeout(3000);
            const describe = window.describe,
                test = window.test,
                dom = window.dom,
                on = window.on,
                expect = chai.expect,
                body = dom.byId('tests');


            const inputSchema = {
                columns: [
                    {
                        key: 'fromAmount',
                        label: 'Monthly Billing From',
                        component: {
                            type: 'ui-input',
                            format: 'currency',
                        },
                    },
                    {
                        key: 'toAccount',
                        label: 'Monthly Billing To',
                        component: {
                            type: 'ui-input',
                            format: 'currency',
                        },
                    },
                    {
                        key: 'downpaymentPercentage',
                        label: 'Down Payment',
                        component: {
                            type: 'ui-input',
                            format: 'percentage',
                        },
                    },
                    {
                        key: 'monthlyPercentage',
                        label: 'Monthly Payment',
                        component: {
                            type: 'ui-input',
                            format: 'percentage',
                        },
                    },
                    {
                        key: 'months',
                        label: 'Months',
                        component: {
                            type: 'ui-input',
                            format: 'integer',
                        },
                    },
                    {
                        icon: 'edit',
                        component: {
                            type: 'edit-rows',
                        },
                    },
                ],
            };


            const inputData = {
                schema: inputSchema,
                items: [
                    {
                        id: 1,
                        typeId: 2000,
                        fromAmount: 5,
                        toAccount: 1500,
                        downpaymentPercentage: 60,
                        monthlyPercentage: 20,
                        months: 13,
                        name: 'Monthly Billing To',
                    },
                    {
                        id: 2,
                        typeId: 2000,
                        fromAmount: 1500,
                        toAccount: 3000,
                        downpaymentPercentage: 40,
                        monthlyPercentage: 15,
                        months: 20,
                        name: 'Monthly Billing To',
                    },
                    {
                        id: 3,
                        typeId: 2000,
                        fromAmount: 3000,
                        toAccount: 6000,
                        downpaymentPercentage: 30,
                        monthlyPercentage: 10,
                        months: 30,
                        name: 'Monthly Billing To',
                    },
                    {
                        id: 4,
                        typeId: 2000,
                        fromAmount: 6000,
                        toAccount: 10000,
                        downpaymentPercentage: 15,
                        monthlyPercentage: 10,
                        months: 32,
                        name: 'Monthly Billing To',
                    },
                    {
                        id: 5,
                        typeId: 2000,
                        fromAmount: 10000,
                        toAccount: null,
                        downpaymentPercentage: 5,
                        monthlyPercentage: 5,
                        months: 65,
                        name: 'Monthly Billing To',
                    },
                    {
                        id: 6,
                        typeId: 2001,
                        fromAmount: 50,
                        toAccount: 3000,
                        downpaymentPercentage: 30,
                        monthlyPercentage: 5,
                        months: 72,
                        name: 'Monthly Billing From',
                    },
                    {
                        id: 7,
                        typeId: 2001,
                        fromAmount: 3000,
                        toAccount: 6000,
                        downpaymentPercentage: 15,
                        monthlyPercentage: 5,
                        months: 72,
                        name: 'Monthly Billing From',
                    },
                    {
                        id: 8,
                        typeId: 2001,
                        fromAmount: 6000,
                        toAccount: null,
                        downpaymentPercentage: 5,
                        monthlyPercentage: 5,
                        months: 72,
                        name: 'Monthly Billing From',
                    },
                    {
                        id: 9,
                        typeId: 2002,
                        fromAmount: null,
                        toAccount: null,
                        downpaymentPercentage: 20,
                        monthlyPercentage: 10,
                        months: null,
                        name: 'Down Payment',
                    },
                    {
                        id: 10,
                        typeId: 2003,
                        fromAmount: null,
                        toAccount: null,
                        downpaymentPercentage: 30,
                        monthlyPercentage: 20,
                        months: null,
                        name: 'Monthly Payment',
                    },
                    {
                        id: 11,
                        typeId: 2004,
                        fromAmount: 1000,
                        toAccount: 2000,
                        downpaymentPercentage: 10,
                        monthlyPercentage: 10,
                        months: 12,
                        name: 'Months',
                    },
                    {
                        id: 12,
                        typeId: 2004,
                        fromAmount: 2000,
                        toAccount: null,
                        downpaymentPercentage: 15,
                        monthlyPercentage: 15,
                        months: 24,
                        name: 'Months',
                    },
                ],
            };


            const data1 = {
                schema: {
                    sort: 'weight',
                    desc: true,
                    columns: [
                        {key: 'name', label: 'Name'},
                        {key: 'age', label: 'Age'},
                        {key: 'height', label: 'Height'},
                        {key: 'weight', label: 'Weight'},
                        {key: 'bp', label: 'Blood Pressure', unsortable: true},
                    ],
                },
                items: [
                    {
                        id: 1,
                        name: 'Moke',
                        age: 20,
                        height: 6.1,
                        weight: 170,
                        bp: 120
                    }, {
                        id: 2,
                        name: 'Joke',
                        age: 10,
                        height: 4.5,
                        weight: 90,
                        bp: 100
                    }, {
                        id: 3,
                        name: 'Doke',
                        age: 40,
                        height: 5.9,
                        weight: 220,
                        bp: 150
                    }
                ]
            },
                data2 = {},
                data3 = {
                    schema: {
                        columns: [
                            {
                                key: 'last',
                                label: 'Last',
                                callback(item) {
                                    console.log('format!!');
                                    return `${item.last}, ${item.first}`;
                                }
                            }, {
                                key: 'middle',
                                label: 'Middle Name',
                                component: {
                                    type: 'ui-input',
                                    subtype: 'text'
                                }
                            }, {
                                key: 'job',
                                label: 'Occupation',
                                component: {
                                    type: 'link',
                                    url: 'site'
                                }
                            }, {
                                key: 'edu',
                                label: 'Education',
                                component: {
                                    type: 'ui-dropdown',
                                    options: [
                                        {value: 'bootcamp', label: 'Boot Camp'},
                                        {value: 'highschool', label: 'High School'},
                                        {value: 'associates', label: 'Associates'},
                                        {value: 'bachelors', label: 'Bachelors'},
                                        {value: 'masters', label: 'Masters'},
                                    ]
                                }
                            },{
                                key: 'school',
                                label: 'School',
                                component: {
                                    key: 'schoolId',
                                    type: 'ui-dropdown',
                                    options: [
                                        {value: 1, label: 'Yale'},
                                        {value: 2, label: 'Harvard'},
                                        {value: 3, label: 'Cornell'},
                                        {value: 4, label: 'Princeton'},
                                        {value: 5, label: 'Dartmouth'},
                                    ]
                                }
                            }, {
                                key: 'optin',
                                label: 'Opt In',
                                width: '80px',
                                component: {
                                    type: 'ui-checkbox'
                                }
                            }, {
                                icon: 'edit',
                                component: {
                                    type: 'edit-rows'
                                }
                            }
                        ]
                    },
                    items: [
                        {
                            id: 1,
                            first: 'Mike',
                            last: 'Wilcox',
                            middle: 'JavaScript',
                            job: 'UI Guy',
                            company: 'Intelligencia',
                            site: 'http://intelligencia.com',
                            edu: 'associates',
                            optin: true,
                            school: 'Yale',
                            schoolId: 1
                        }, {
                            id: 2,
                            first: 'Jeziel',
                            last: 'Jones',
                            middle: 'Hello Kitty',
                            job: 'UI Guy',
                            company: 'Dorkville',
                            site: 'http://dorkville.us',
                            edu: 'bootcamp',
                            optin: false,
                            school: 'Harvard',
                            schoolId: 2
                        }, {
                            id: 3,
                            first: 'Motti',
                            last: 'Marom',
                            middle: '',
                            job: 'Criticizing',
                            company: 'QA R US',
                            site: 'http://qarus.com',
                            edu: 'bachelors',
                            optin: true,
                            school: 'Cornell',
                            schoolId: 3
                        }, {
                            id: 4,
                            first: 'Madhu',
                            last: 'Chebrolu',
                            middle: true,
                            job: 'Rubier',
                            company: 'Backends',
                            site: 'http://bends.com',
                            edu: 'masters',
                            optin: false,
                            school: 'Princeton',
                            schoolId: 4
                        }
                    ]
                },
                data4 = {
                    schema: {
                        columns: [{
                            key: 'money',
                            label: 'USD',
                            component: {
                                type: 'ui-input',
                                format: 'currency'
                            }
                        }, {
                            key: 'percentage',
                            label: '%',
                            component: {
                                type: 'ui-input',
                                format: 'percentage'
                            }
                        }, {
                            key: 'months',
                            label: 'Months',
                            component: {
                                type: 'ui-input',
                                format: 'integer'
                            }
                        }]
                    },
                    items: [
                        {
                            id: 1,
                            money: 6,
                            percentage: 50,
                            months: 6
                        }, {
                            id: 2,
                            money: 1.20,
                            percentage: 5,
                            months: 1
                        }, {
                            id: 3,
                            money: 0,
                            percentage: 99,
                            months: 0
                        }
                    ]
                },
                dataNoItems = {
                    schema: {
                        columns: {
                            name: 'Name',
                            age: 'Age',
                            height: 'Height',
                            weight: 'Weight',
                            bp: 'Bloodpressure'
                        }
                    },
                    items: []
                };

            function getData() {
                const data = getData20();
                delete data.columns.email;
                delete data.columns.phone;
                delete data.columns.ssn;
                delete data.columns.birthday;
                delete data.columns.address1;
                delete data.columns.address2;
                return data;
            }

            describe('formatters', () => {
                it('should format integers', () => {
                    const toHtml = formatters.integer.toHtml;
                    const fromHtml = formatters.integer.fromHtml;
                    expect(toHtml('a1')).to.equal('1');
                    expect(toHtml('1.1')).to.equal('1');
                    expect(toHtml('1.0')).to.equal('1');
                    expect(toHtml('-1.0')).to.equal('-1');
                    
                    expect(fromHtml('a1')).to.equal('1');
                });

                it('should format percentages', () => {
                    const toHtml = formatters.percentage.toHtml;
                    const fromHtml = formatters.percentage.fromHtml;
                    expect(toHtml('1')).to.equal('1%');
                    expect(toHtml('01')).to.equal('1%');
                    expect(toHtml('001')).to.equal('1%');
                    expect(toHtml('a1')).to.equal('1%');
                    expect(toHtml('1.1')).to.equal('1.1%');
                    expect(toHtml('1.0')).to.equal('1.0%');
                    expect(toHtml('1.00')).to.equal('1.00%');
                    expect(toHtml('1.000')).to.equal('1.000%');
                    expect(toHtml('-1.0')).to.equal('-1.0%');
                    
                    expect(fromHtml('1%')).to.equal('1');
                    expect(fromHtml('1.1%')).to.equal('1.1');
                    expect(fromHtml('1.00%')).to.equal('1.00');
                    expect(fromHtml('-10%')).to.equal('-10');
                });

                it('should format currency', () => {
                    const toHtml = formatters.currency.toHtml;
                    const fromHtml = formatters.currency.fromHtml;
                    expect(toHtml('1')).to.equal('$1.00');
                    expect(toHtml('1.001')).to.equal('$1.00');
                    expect(toHtml('1.01')).to.equal('$1.01');
                    expect(toHtml('1.009')).to.equal('$1.01');
                    expect(toHtml('-1')).to.equal('-$1.00');
                    expect(toHtml('.01')).to.equal('$0.01');
                    expect(toHtml('0.01')).to.equal('$0.01');

                    expect(toHtml('10')).to.equal('$10.00');
                    expect(toHtml('100')).to.equal('$100.00');
                    expect(toHtml('1000')).to.equal('$1,000.00');
                    expect(toHtml('10000.00')).to.equal('$10,000.00');
                    
                    expect(toHtml('-10')).to.equal('-$10.00');
                    expect(toHtml('-100')).to.equal('-$100.00');
                    expect(toHtml('-1000')).to.equal('-$1,000.00');
                    expect(toHtml('-10000.00')).to.equal('-$10,000.00');

                    expect(fromHtml('$1')).to.equal('1');
                    expect(fromHtml('$1.00')).to.equal('1.00');
                    expect(fromHtml('-$1.00')).to.equal('-1.00');
                });

                it('should format accounting', () => {
                    const toHtml = formatters.accounting.toHtml;
                    const fromHtml = formatters.accounting.fromHtml;
                    expect(toHtml('1')).to.equal('$1.00');
                    expect(toHtml('1.001')).to.equal('$1.00');
                    expect(toHtml('1.01')).to.equal('$1.01');
                    expect(toHtml('1.009')).to.equal('$1.01');
                    expect(toHtml('-1')).to.equal('($1.00)');
                    expect(toHtml('.01')).to.equal('$0.01');
                    expect(toHtml('0.01')).to.equal('$0.01');

                    expect(toHtml('1000')).to.equal('$1,000.00');
                    expect(toHtml('10000.00')).to.equal('$10,000.00');
                    
                    expect(toHtml('-10')).to.equal('($10.00)');
                    expect(toHtml('-100')).to.equal('($100.00)');
                    expect(toHtml('-1000')).to.equal('($1,000.00)');
                    expect(toHtml('-10000.00')).to.equal('($10,000.00)');

                    expect(fromHtml('$1')).to.equal('1');
                    expect(fromHtml('$1.00')).to.equal('1.00');
                    expect(fromHtml('-$1.00')).to.equal('-1.00');
                    expect(fromHtml('($1.00)')).to.equal('-1.00');
                });
            });

            describe('data table', function () {
                describe('new schema + components', function () {
                    it('should add/remove rows', function (done) {
                        const data = copy(data3);
                        const section = dom('section', {html: dom('label', {html: 'Add/Remove Rows'})}, body);
                        const node = dom('data-table', {
                            schema: data.schema,
                            rows: data.items,
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('change', function (e) {
                                console.log('change', e);
                            });
                            node.on('remove-row', function (e) {
                                console.log('remove-row', e);
                            });
                            done();
                        });
                    });

                    it('should add/remove input rows', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Add/Remove Rows'})}, body);
                        const items = inputData.items.slice(0,1);
                        const node = dom('data-table', {
                            schema: inputData.schema,
                            rows: items,
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('change', function (e) {
                                console.log('change', e);
                            });
                            node.on('add-row', function (e) {
                                console.log('change', e);
                                delete e.value.added;
                                items.splice(e.value.index, 0, e.value);
                                node.rows = items;
                            });
                            node.on('remove-row', function (e) {
                                console.log('remove-row', e);
                                items.splice(e.value.index, 1);
                                node.rows = items;
                            });
                            done();
                        });
                    });

                    it('should add/remove with an actionbutton', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Add/Remove ActionButton'})}, body);
                        const schema = copy(inputData.schema);
                        schema.columns[schema.columns.length - 1].component.options = [
                            {value: 'add', label: 'Add Row'},
                            {value: 'edit', label: 'Edit Row'},
                            {value: 'remove', label: 'Remove Row'},
                        ]
                        console.log('schema', schema);
                        const items = inputData.items.slice(0,2);
                        const node = dom('data-table', {
                            schema,
                            rows: items,
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('change', function (e) {
                                console.log('change', e);
                            });
                            node.on('add-row', function (e) {
                                console.log('change', e);
                                delete e.value.added;
                                items.splice(e.value.index, 0, e.value);
                                node.rows = items;
                            });
                            node.on('remove-row', function (e) {
                                console.log('remove-row', e);
                                items.splice(e.value.index, 1);
                                node.rows = items;
                            });
                            done();
                        });
                    });

                    it('should format data', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'New Schema + Components'})}, body);
                        const node = dom('data-table', {
                            schema: data3.schema,
                            rows: data3.items,
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('change', function (e) {
                                console.log('change', e);
                            });
                            done();
                        });
                    });

                    it('should start from empty', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'New Schema + Components'})}, body);
                        const node = dom('data-table', {
                            schema: data3.schema,
                            rows: data3.items,
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('change', function (e) {
                                console.log('change', e);
                            });
                            done();
                        });
                    });

                    it('should be formatable', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Formatable Inputs'})}, body);
                        const node = dom('data-table', {
                            schema: data4.schema,
                            rows: data4.items,
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('change', function (e) {
                                console.log('change', e);
                            });
                            done();
                        });
                    });
                });

                describe('grouping', () => {


                    // TODO: accordion

                    it.only('should group inline data', (done) => {
                        const section = dom('section', {html: dom('label', {html: 'Group Child Data'})}, body);
                        const node = dom('data-table', {
                            schema: groupedSchema,
                            rows: groupedItems,
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('change', function (e) {
                                console.log('change', e);
                            });
                            node.on('remove-row', function (e) {
                                console.log('remove-row', e);
                            });
                            done();
                        });
                    });
                });

                describe('rendering', function () {
                    it('should render a table', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Non Selectable Item'})}, body);
                        const node = dom('data-table', {
                            schema: data3.schema,
                            rows: data3.items
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            done();
                        });
                    });

                    it('should handle "no data"', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Data is NULL'})}, body);
                        const node = dom('data-table', {
                            rows: [],
                            schema: {}
                        }, section);
                        onDomReady(node, function () {
                            expect(node.classList.contains('no-data')).to.equal(true);
                            done();
                        });
                    });

                    it('should handle "no items"', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Items are []'})}, body);
                        const node = dom('data-table', {
                            schema: dataNoItems.schema,
                            rows: dataNoItems.items
                        }, section);
                        onDomReady(node, function () {
                            expect(node.classList.contains('no-data')).to.equal(true);
                            done();
                        });
                    });

                    // it('should render a footer', function (done) {
                    //     const section = dom('section', {html: dom('label', {html: 'Non Selectable Item'})}, body);
                    //     const node = dom('data-table', {
                    //         schema: data3.schema,
                    //         rows: data3.items,
                    //         footer: 'There is text in the footer'
                    //     }, section);
                    //     const events = [];
                    //     onDomReady(node, function () {
                    //         done();
                    //     });
                    // });
                });

                describe('clickable', function () {
                    it('should have clickable rows', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Clickable Rows'})}, body);
                        const node = dom('data-table', {
                            schema: data1.schema,
                            rows: data1.items,
                            clickable: true
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('row-click', function (e) {
                                console.log('click', e);
                            });
                            node.on('header-click', function (e) {
                                console.log('click', e);
                            });
                            done();
                        });
                    });
                });

                describe('scrolling', function () {

                    it('should be scrollable', function (done) {
                        const data = getData();
                        const section = dom('section', {class: 'sized', html: 'Scrollable'}, body);
                        const node = dom('data-table', {
                            schema: {columns: data.columns},
                            rows: data.items,
                            scrollable: true
                        }, section);
                        onDomReady(node, function () {
                            done();
                        });
                    });

                    it('should be scrollable with maxHeight set', function (done) {
                        const data = getData();
                        const section = dom('section', {html: 'Scrollable, Max Height'}, body);
                        const node = dom('data-table', {
                            schema: {columns: data.columns},
                            rows: data.items,
                            scrollable: true,
                            'max-height': 200
                        }, section);
                        onDomReady(node, function () {
                            done();
                        });
                    });
                });

                describe('sorting', function () {
                    it('should sort', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Sortable 1'})}, body);
                        const node = dom('data-table', {
                            schema: data1.schema,
                            rows: data1.items,
                            footer: dom('div', {html: 'select one of two rows'})
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('sort', function (e) {
                                //console.log('sort.event', e);
                                events.push(e.detail.value);
                            });

                            // expect(selectedColumn(node)).to.equal('weight');
                            // expect(getColData(node, 'weight')).to.equal('220,170,90');
                            // clickCol(node, 'weight');
                            // expect(getColData(node, 'weight')).to.equal('90,170,220');

                            // // reset to default sort
                            // clickCol(node, 'weight');
                            // expect(getColData(node, 'weight')).to.equal('170,90,220');
                            // expect(selectedColumn(node)).to.equal(null);

                            // clickCol(node, 'age');
                            // expect(selectedColumn(node)).to.equal('age');
                            // expect(getColData(node, 'age')).to.equal('40,20,10');

                            // clickCol(node, 'bp');
                            // expect(selectedColumn(node)).to.equal('bp');
                            // expect(getColData(node, 'bp')).to.equal('150,120,100');

                            // node.sort = 'height,desc';
                            // expect(selectedColumn(node)).to.equal('height');
                            // expect(getColData(node, 'height')).to.equal('6.1,5.9,4.5');


                            // node.sort = 'age';
                            // expect(selectedColumn(node)).to.equal('age');
                            // expect(getColData(node, 'age')).to.equal('40,20,10');

                            // node.sort = null;

                            // expect(events.join(';')).to.equal('weight,asc;weight,;age,desc;bp,desc;height,desc;age,desc;');

                            // destroy(node);
                            done();
                        });
                    });

                    it('should server-based sort', function (done) {

                        const extsort = {
                            field: 'age',
                            dir: 'desc'
                        };
                        const schema = {
                            columns: data1.schema.columns
                        };
                        const section = dom('section', {html: dom('label', {html: 'Server Sortable onSort'})}, body);
                        const node = dom('data-table', {
                            schema,
                            rows: data1.items,
                            extsort,
                            // serversort: true,
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('sort', function (e) {
                                console.log('sort.event', e.detail);
                                const update = {
                                    field: e.detail.field,
                                    dir: e.detail.dir
                                };

                                setTimeout(() => {
                                    node.extsort = update;
                                }, 400);
                                events.push(e.detail.value);
                            });
                            done();
                        });
                    });
                });

                describe('selecting', function () {
                    it('should be selectable', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Selectable'})}, body);
                        const node = dom('data-table', {
                            schema: data1.schema,
                            rows: data1.items,
                            selectable: true
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('change', function (e) {
                                console.log('chn', e);
                                events.push(e.value);
                            });
                            clickRow(node, 1);
                            expect(getSelectedRowId(node)).to.equal('1');
                            clickRow(node, 0);
                            expect(getSelectedRowId(node)).to.equal('3');
                            clickRow(node, 2);
                            expect(getSelectedRowId(node)).to.equal('2');
                            // deselect
                            clickRow(node, 2);
                            expect(getSelectedRowId(node)).to.equal(null);
                            expect(events.join(',')).to.equal('1,3,2,'); // last one is blank
                            destroy(node);

                            node.selected = 1;
                            expect(getSelectedRowId(node)).to.equal('1');

                            // test getter
                            expect(node.selected).to.equal(1);

                            node.selected = null;
                            expect(getSelectedRowId(node)).to.equal(null);

                            done();
                        });
                    });

                    // it.only('should handle non-selectable items', function (done) {

                    // currently broken - looking to set unselectable to the css of a row

                    //     const section = dom('section', {html: dom('label', {html: 'Non Selectable Item'})}, body);
                    //     const node = dom('data-table', {
                    //         schema: data3.schema,
                    //         rows: data3.items,
                    //         selectable: true,
                    //     }, section);
                    //     const events = [];
                    //     onDomReady(node, function () {

                    //         clickRow(node, 1);
                    //         expect(getSelectedRowId(node)).to.equal('4');

                    //         clickRow(node, 0);
                    //         expect(getSelectedRowId(node)).to.equal(null);

                    //         done();
                    //     });
                    // });
                });

                describe('sort and select', function () {
                    it('should sort and select', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Sortable and Selectable'})}, body);
                        const node = dom('data-table', {
                            schema: data1.schema,
                            rows: data1.items,
                            selectable: true
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            clickCol(node, 'weight');
                            expect(getColData(node, 'weight')).to.equal('90,170,220');

                            clickRow(node, 1);
                            expect(getSelectedRowId(node)).to.equal('1');

                            expect(getSelectedRowIdIndex(node)).to.equal(2);

                            clickCol(node, 'height');
                            expect(getSelectedRowId(node)).to.equal('1');
                            expect(getSelectedRowIdIndex(node)).to.equal(1);

                            done();
                        });
                    });

                    it('should maintain sort and select after new items', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Sortable and Selectable'})}, body);
                        const node = dom('data-table', {
                            schema: data1.schema,
                            rows: data1.items,
                            sortable: true,
                            selectable: true
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            clickCol(node, 'weight');
                            expect(getColData(node, 'weight')).to.equal('90,170,220');

                            clickRow(node, 1);
                            expect(getSelectedRowId(node)).to.equal('1');

                            expect(getSelectedRowIdIndex(node)).to.equal(2);

                            clickCol(node, 'height');
                            expect(getSelectedRowId(node)).to.equal('1');
                            expect(getSelectedRowIdIndex(node)).to.equal(1);

                            node.data = data2;

                            expect(selectedColumn(node)).to.equal('height');
                            expect(getSelectedRowId(node)).to.equal('1');
                            expect(getSelectedRowIdIndex(node)).to.equal(1);

                            done();
                        });
                    });
                });

            });

        });

        function selectedColumn(node) {
            const th = dom.query(node, '.desc,.asc');
            if (!th) {
                return null;
            }
            return dom.attr(th, 'data-field');
        }

        function clickCol(node, field) {
            const th = dom.query(node, '[data-field="' + field + '"]');
            if (!th) {
                console.warn('th not found', field);
                return null
            }
            on.emit(th, 'click');
        }

        function clickRow(node, index) {
            const row = node.tbody.rows[index];
            on.emit(row, 'click');
        }

        function getSelectedRowId(node) {
            const tr = dom.query(node, '.selected');
            return tr ? dom.attr(tr, 'data-row-id') : null;
        }

        function getSelectedRowIdIndex(node) {
            const tr = dom.query(node, '.selected');
            return (tr || {rowIndex: null}).rowIndex;
        }

        function getColData(node, field) {
            const cells = dom.queryAll(node, 'tbody [data-field="' + field + '"]');
            return cells.map(function (cell) {
                return cell.textContent;
            }).join(',');
        }

        function copy(data) {
            return JSON.parse(JSON.stringify(data));
        }

        function destroy(node) {
            //node.destroy();
        }

        window.mocha.run();


    </script>
</body>

</html>