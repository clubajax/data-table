<!DOCTYPE HTML>
<html lang="en">

<head>
    <title>Test Data Table</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css"
        integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz" crossorigin="anonymous">
    <script src="src/test-files.js"></script>
    <script src="//localhost:35750/livereload.js"></script>

    <style>
        html,
        body {
            height: 100%;
        }

        body {
            padding: 20px;
            font-family: sans-serif;
        }

        section {
            border: 1px solid #ccc;
            padding: 3px;
            margin: 5px;
        }

        section label {
            display: block;
            padding: 5px;
        }

        .sized {
            height: 300px;
        }
    </style>
</head>

<body>
    <h1>Test Data Table</h1>

    <div id="mocha"></div>
    <div id="tests"></div>

    <script>
        window.mocha.setup('bdd');
        window.mocha.options.allowUncaught = true;


        function createSchema(options) {
            return {
                name: 'Name',
                age: 'Age',
                height: 'Height',
                weight: 'Weight',
                bp: 'Bloodpressure'
            }
        }
        describe('DataTable', function () {
            this.timeout(3000);
            const describe = window.describe,
                test = window.test,
                dom = window.dom,
                on = window.on,
                expect = chai.expect,
                body = dom.byId('tests');

            const data1 = {
                schema: {
                    sort: 'weight',
                    desc: true,
                    columns: [
                        {key: 'name', label: 'Name'},
                        {key: 'age', label: 'Age'},
                        {key: 'height', label: 'Height'},
                        {key: 'weight', label: 'Weight'},
                        {key: 'bp', label: 'Blood Pressure', unsortable: true},
                    ],
                },
                items: [
                    {
                        id: 1,
                        name: 'Moke',
                        age: 20,
                        height: 6.1,
                        weight: 170,
                        bp: 120
                    }, {
                        id: 2,
                        name: 'Joke',
                        age: 10,
                        height: 4.5,
                        weight: 90,
                        bp: 100
                    }, {
                        id: 3,
                        name: 'Doke',
                        age: 40,
                        height: 5.9,
                        weight: 220,
                        bp: 150
                    }
                ]
            },
                data2 = {},
                data3 = {
                    schema: {
                        sort: 'first',
                        columns: [
                            {
                                key: 'first',
                                label: 'First'
                            }, {
                                key: 'last',
                                label: 'Last'
                            }, {
                                key: 'middle',
                                label: 'Middle Name',
                                component: {
                                    type: 'ui-input',
                                    subtype: 'text'
                                }
                            }, {
                                key: 'job',
                                label: 'Occupation',
                                component: {
                                    type: 'link',
                                    url: 'site'
                                }
                            }, {
                                key: 'edu',
                                label: 'Education',
                                component: {
                                    type: 'ui-dropdown',
                                    options: [
                                        {value: 'bootcamp', label: 'Boot Camp'},
                                        {value: 'highschool', label: 'High School'},
                                        {value: 'associates', label: 'Associates'},
                                        {value: 'bachelors', label: 'Bachelors'},
                                        {value: 'masters', label: 'Masters'},
                                    ]
                                }
                            }, {
                                key: 'optin',
                                label: 'Opt In',
                                width: '70px',
                                component: {
                                    type: 'ui-checkbox'
                                }
                            }
                        ]
                    },
                    items: [
                        {
                            id: 1,
                            first: 'Mike',
                            last: 'Wilcox',
                            middle: 'JavaScript',
                            job: 'UI Guy',
                            company: 'Intelligencia',
                            site: 'http://intelligencia.com',
                            edu: 'associates',
                            optin: true
                        }, {
                            id: 2,
                            first: 'Jeziel',
                            last: 'Jones',
                            middle: 'Hello Kitty',
                            job: 'UI Guy',
                            company: 'Dorkville',
                            site: 'http://dorkville.us',
                            edu: 'bootcamp',
                            optin: false
                        }, {
                            id: 3,
                            first: 'Motti',
                            last: 'Marom',
                            middle: '',
                            job: 'Criticizing',
                            company: 'QA R US',
                            site: 'http://qarus.com',
                            edu: 'bachelors',
                            optin: true
                        }, {
                            id: 4,
                            first: 'Madhu',
                            last: 'Chebrolu',
                            middle: true,
                            job: 'Rubier',
                            company: 'Backends',
                            site: 'http://bends.com',
                            edu: 'masters',
                            optin: false
                        }
                    ]
                },
                data4 = {
                    schema: {
                        columns: [{
                            key: 'money',
                            label: 'USD',
                            component: {
                                type: 'ui-input',
                                format: 'currency'
                            }
                        }, {
                            key: 'percentage',
                            label: '%',
                            component: {
                                type: 'ui-input',
                                format: 'percentage'
                            }
                        }, {
                            key: 'months',
                            label: 'Months',
                            component: {
                                type: 'ui-input',
                                format: 'integer'
                            }
                        }]
                    },
                    items: [
                        {
                            id: 1,
                            money: 6,
                            percentage: 50,
                            months: 6
                        }, {
                            id: 2,
                            money: 1.20,
                            percentage: 5,
                            months: 1
                        }, {
                            id: 3,
                            money: 0,
                            percentage: 99,
                            months: 0
                        }
                    ]
                },
                dataNoItems = {
                    schema: {
                        columns: {
                            name: 'Name',
                            age: 'Age',
                            height: 'Height',
                            weight: 'Weight',
                            bp: 'Bloodpressure'
                        }
                    },
                    items: []
                };

            function getData() {
                const data = getData20();
                delete data.columns.email;
                delete data.columns.phone;
                delete data.columns.ssn;
                delete data.columns.birthday;
                delete data.columns.address1;
                delete data.columns.address2;
                return data;
            }


            describe('data table', function () {
                describe('new schema + components', function () {
                    it('should be editable', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'New Schema + Components'})}, body);
                        const node = dom('data-table', {
                            schema: data3.schema,
                            rows: data3.items,
                            // borders: 'bottom',
                            // clickable: true,
                            // sortable: true
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('change', function (e) {
                                console.log('change', e);
                            });
                            done();
                        });
                    });

                    it('should be formatable', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Formatable Inputs'})}, body);
                        const node = dom('data-table', {
                            schema: data4.schema,
                            rows: data4.items,
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('change', function (e) {
                                console.log('change', e);
                            });
                            done();
                        });
                    });
                })

                describe('rendering', function () {
                    it('should render a table', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Non Selectable Item'})}, body);
                        const node = dom('data-table', {
                            schema: data3.schema,
                            rows: data3.items
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            done();
                        });
                    });

                    it('should handle "no data"', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Data is NULL'})}, body);
                        const node = dom('data-table', {
                            rows: [],
                            schema: {}
                        }, section);
                        onDomReady(node, function () {
                            expect(node.classList.contains('no-data')).to.equal(true);
                            done();
                        });
                    });

                    it('should handle "no items"', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Items are []'})}, body);
                        const node = dom('data-table', {
                            schema: dataNoItems.schema,
                            rows: dataNoItems.items
                        }, section);
                        onDomReady(node, function () {
                            expect(node.classList.contains('no-data')).to.equal(true);
                            done();
                        });
                    });

                    // it('should render a footer', function (done) {
                    //     const section = dom('section', {html: dom('label', {html: 'Non Selectable Item'})}, body);
                    //     const node = dom('data-table', {
                    //         schema: data3.schema,
                    //         rows: data3.items,
                    //         footer: 'There is text in the footer'
                    //     }, section);
                    //     const events = [];
                    //     onDomReady(node, function () {
                    //         done();
                    //     });
                    // });
                });

                describe('clickable', function () {
                    it('should have clickable rows', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Clickable Rows'})}, body);
                        const node = dom('data-table', {
                            schema: data1.schema,
                            rows: data1.items,
                            clickable: true
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('row-click', function (e) {
                                console.log('click', e);
                            });
                            node.on('header-click', function (e) {
                                console.log('click', e);
                            });
                            done();
                        });
                    });
                });

                describe('scrolling', function () {

                    it('should be scrollable', function (done) {
                        const data = getData();
                        const section = dom('section', {class: 'sized', html: 'Scrollable'}, body);
                        const node = dom('data-table', {
                            schema: {columns: data.columns},
                            rows: data.items,
                            scrollable: true
                        }, section);
                        onDomReady(node, function () {
                            done();
                        });
                    });

                    it('should be scrollable with maxHeight set', function (done) {
                        const data = getData();
                        const section = dom('section', {html: 'Scrollable, Max Height'}, body);
                        const node = dom('data-table', {
                            schema: {columns: data.columns },
                            rows: data.items,
                            scrollable: true,
                            'max-height': 200
                        }, section);
                        onDomReady(node, function () {
                            done();
                        });
                    });
                });

                describe('sorting', function () {
                    it('should sort', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Sortable 1'})}, body);
                        const node = dom('data-table', {
                            schema: data1.schema,
                            rows: data1.items,
                            // sortable: true,
                            footer: dom('div', {html: 'select one of two rows'})
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('sort', function (e) {
                                //console.log('sort.event', e);
                                events.push(e.detail.value);
                            });

                            // expect(selectedColumn(node)).to.equal('weight');
                            // expect(getColData(node, 'weight')).to.equal('220,170,90');
                            // clickCol(node, 'weight');
                            // expect(getColData(node, 'weight')).to.equal('90,170,220');

                            // // reset to default sort
                            // clickCol(node, 'weight');
                            // expect(getColData(node, 'weight')).to.equal('170,90,220');
                            // expect(selectedColumn(node)).to.equal(null);

                            // clickCol(node, 'age');
                            // expect(selectedColumn(node)).to.equal('age');
                            // expect(getColData(node, 'age')).to.equal('40,20,10');

                            // clickCol(node, 'bp');
                            // expect(selectedColumn(node)).to.equal('bp');
                            // expect(getColData(node, 'bp')).to.equal('150,120,100');

                            // node.sort = 'height,desc';
                            // expect(selectedColumn(node)).to.equal('height');
                            // expect(getColData(node, 'height')).to.equal('6.1,5.9,4.5');


                            // node.sort = 'age';
                            // expect(selectedColumn(node)).to.equal('age');
                            // expect(getColData(node, 'age')).to.equal('40,20,10');

                            // node.sort = null;

                            // expect(events.join(';')).to.equal('weight,asc;weight,;age,desc;bp,desc;height,desc;age,desc;');

                            // destroy(node);
                            done();
                        });
                    });

                    it.only('should server-based sort', function (done) {

                        const extsort = {
                            field: 'weight',
                            dir: 'desc'
                        };
                        const schema = {
                            columns:data1.schema.columns 
                        };
                        const section = dom('section', {html: dom('label', {html: 'Server Sortable onSort'})}, body);
                        const node = dom('data-table', {
                            schema,
                            rows: data1.items,
                            extsort,
                            // serversort: true,
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            console.log('ready');
                            node.on('sort', function (e) {
                                console.log('sort.event', e.detail);
                                const update = {
                                    field: e.detail.field,
                                    dir: e.detail.dir
                                };

                                setTimeout(() => {
                                    node.extsort = update;
                                }, 400);
                                events.push(e.detail.value);
                            });
                            done();
                        });
                    });
                });

                describe('selecting', function () {
                    it('should be selectable', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Selectable'})}, body);
                        const node = dom('data-table', {
                            schema: data1.schema,
                            rows: data1.items,
                            selectable: true
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('change', function (e) {
                                console.log('chn', e);
                                events.push(e.value);
                            });
                            clickRow(node, 1);
                            expect(getSelectedRowId(node)).to.equal('1');
                            clickRow(node, 0);
                            expect(getSelectedRowId(node)).to.equal('3');
                            clickRow(node, 2);
                            expect(getSelectedRowId(node)).to.equal('2');
                            // deselect
                            clickRow(node, 2);
                            expect(getSelectedRowId(node)).to.equal(null);
                            expect(events.join(',')).to.equal('1,3,2,'); // last one is blank
                            destroy(node);

                            node.selected = 1;
                            expect(getSelectedRowId(node)).to.equal('1');

                            // test getter
                            expect(node.selected).to.equal(1);

                            node.selected = null;
                            expect(getSelectedRowId(node)).to.equal(null);

                            done();
                        });
                    });

                    // it.only('should handle non-selectable items', function (done) {

                    // currently broken - looking to set unselectable to the css of a row

                    //     const section = dom('section', {html: dom('label', {html: 'Non Selectable Item'})}, body);
                    //     const node = dom('data-table', {
                    //         schema: data3.schema,
                    //         rows: data3.items,
                    //         selectable: true,
                    //     }, section);
                    //     const events = [];
                    //     onDomReady(node, function () {

                    //         clickRow(node, 1);
                    //         expect(getSelectedRowId(node)).to.equal('4');

                    //         clickRow(node, 0);
                    //         expect(getSelectedRowId(node)).to.equal(null);

                    //         done();
                    //     });
                    // });
                });

                describe('sort and select', function () {
                    it('should sort and select', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Sortable and Selectable'})}, body);
                        const node = dom('data-table', {
                            schema: data1.schema,
                            rows: data1.items,
                            selectable: true
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            clickCol(node, 'weight');
                            expect(getColData(node, 'weight')).to.equal('90,170,220');

                            clickRow(node, 1);
                            expect(getSelectedRowId(node)).to.equal('1');

                            expect(getSelectedRowIdIndex(node)).to.equal(2);

                            clickCol(node, 'height');
                            expect(getSelectedRowId(node)).to.equal('1');
                            expect(getSelectedRowIdIndex(node)).to.equal(1);

                            done();
                        });
                    });

                    it('should maintain sort and select after new items', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Sortable and Selectable'})}, body);
                        const node = dom('data-table', {
                            schema: data1.schema,
                            rows: data1.items,
                            sortable: true,
                            selectable: true
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            clickCol(node, 'weight');
                            expect(getColData(node, 'weight')).to.equal('90,170,220');

                            clickRow(node, 1);
                            expect(getSelectedRowId(node)).to.equal('1');

                            expect(getSelectedRowIdIndex(node)).to.equal(2);

                            clickCol(node, 'height');
                            expect(getSelectedRowId(node)).to.equal('1');
                            expect(getSelectedRowIdIndex(node)).to.equal(1);

                            node.data = data2;

                            expect(selectedColumn(node)).to.equal('height');
                            expect(getSelectedRowId(node)).to.equal('1');
                            expect(getSelectedRowIdIndex(node)).to.equal(1);

                            done();
                        });
                    });
                });

            });

        });

        function selectedColumn(node) {
            const th = dom.query(node, '.desc,.asc');
            if (!th) {
                return null;
            }
            return dom.attr(th, 'data-field');
        }

        function clickCol(node, field) {
            const th = dom.query(node, '[data-field="' + field + '"]');
            if (!th) {
                console.warn('th not found', field);
                return null
            }
            on.emit(th, 'click');
        }

        function clickRow(node, index) {
            const row = node.tbody.rows[index];
            on.emit(row, 'click');
        }

        function getSelectedRowId(node) {
            const tr = dom.query(node, '.selected');
            return tr ? dom.attr(tr, 'data-row-id') : null;
        }

        function getSelectedRowIdIndex(node) {
            const tr = dom.query(node, '.selected');
            return (tr || {rowIndex: null}).rowIndex;
        }

        function getColData(node, field) {
            const cells = dom.queryAll(node, 'tbody [data-field="' + field + '"]');
            return cells.map(function (cell) {
                return cell.textContent;
            }).join(',');
        }

        function destroy(node) {
            //node.destroy();
        }

        window.mocha.run();


    </script>
</body>

</html>