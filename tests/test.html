<!DOCTYPE HTML>
<html lang="en">

<head>
    <title>Test Data Table</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css"
        integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz" crossorigin="anonymous">
    <script src="src/test-files.js"></script>
    <script src="//localhost:35750/livereload.js"></script>

    <style>
        html,
        body {
            height: 100%;
        }
        * {
            box-sizing: border-box;
        }
        body {
            padding: 20px;
            font-family: sans-serif;
        }

        section {
            border: 1px solid #ccc;
            padding: 3px;
            margin: 5px;
        }

        section label {
            display: block;
            padding: 5px;
        }

        .sized {
            height: 300px;
            padding: 30px;
        }

        .drop-data {
            width: 500px;
            height: 500px;
        }
    </style>
</head>

<body>
    <h1>Test Data Table</h1>

    <div id="mocha"></div>
    <div id="tests">
        <input autofocus />
    </div>

    <script>
        window.mocha.setup('bdd');
        window.mocha.options.allowUncaught = true;


        function createSchema(options) {
            return {
                name: 'Name',
                age: 'Age',
                height: 'Height',
                weight: 'Weight',
                bp: 'Bloodpressure'
            }
        }
        describe('DataTable', function () {
            this.timeout(3000);
            const describe = window.describe,
                util = window.util,
                test = window.test,
                dom = window.dom,
                on = window.on,
                expect = chai.expect,
                body = dom.byId('tests');

            function getData() {
                const data = getData20();
                delete data.columns.email;
                delete data.columns.phone;
                delete data.columns.ssn;
                delete data.columns.birthday;
                delete data.columns.address1;
                delete data.columns.address2;
                return data;
            }

            function getDataForDrops() {
                getDropData();
            }

            let renderNode;
            async function renderDropTable() {
                return new Promise((resolve) => {
                    const data = copy(getDropData());
                    const section = dom('section', {html: dom('label', {html: 'Dropdown Mania'})}, body);
                    console.time('done');
                    renderNode = dom('data-table', {
                        schema: data.schema,
                        rows: data.rows50,
                    }, section);
                    onDomReady(renderNode, function () {
                        console.timeEnd('done');
                        resolve();
                    });
                })
            }

            function destroyRenderNode() {
                renderNode.destroy();
            }

            describe('util', function () {
                it('should create a classname string', () => {
                    const {classnames} = util;
                    let cls;

                    cls = classnames('mike');
                    cls('was');
                    cls('here');
                    expect(cls()).to.equal('mike was here');

                    cls = classnames('');
                    cls('one');
                    cls();
                    cls('two');
                    expect(cls()).to.equal('one two');
                })
            });

            describe('data table', function () {
                describe.skip('performance', function () {
                    it('shuld generate data', function () {
                        let data = getDropData().rows;
                        data = [...data, ...data, ...data, ...data, ...data];
                        data = data.map(({label, typeId, appliedTypeId, rateTypeId, statusId}, i) => {
                            return {
                                id: i + 1,
                                label, typeId, appliedTypeId, rateTypeId, statusId: 48
                            }
                        })
                        const ta = dom('textarea', {class: 'drop-data'}, body);
                        console.log('data', data);
                        ta.textContent = JSON.stringify(data, null, 4)
                    });
                    it('should render many dropdowns', function (done) {
                        async function render() {
                            await renderDropTable();
                            destroyRenderNode();
                            await renderDropTable();
                            destroyRenderNode();
                            await renderDropTable();
                            destroyRenderNode();
                            await renderDropTable();
                            destroyRenderNode();

                            await renderDropTable();
                            destroyRenderNode();
                            await renderDropTable();
                            destroyRenderNode();
                            await renderDropTable();
                            destroyRenderNode();
                            await renderDropTable();
                            destroyRenderNode();

                            await renderDropTable();

                            done();
                        }

                        render();
                    });
                });

                describe('new schema + components', function () {
                    it('should search', function (done) {
                        const data = getSearchData();
                        const section = dom('section', {html: dom('label', {html: 'Search Columns'})}, body);
                        const node = dom('data-table', {
                            schema: data.schema,
                            rows: data.rows,
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('change', function (e) {
                                console.log('change', e);
                            });
                            node.on('cell-change', function (e) {
                                console.log('cell-change', e);
                            });
                            done();
                        });
                    });

                    it('should add/remove rows', function (done) {
                        const data = copy(getData3());
                        const section = dom('section', {html: dom('label', {html: 'Add/Remove Rows'})}, body);
                        const node = dom('data-table', {
                            schema: data.schema,
                            rows: data.items,
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('change', function (e) {
                                console.log('change', e);
                            });
                            node.on('remove-row', function (e) {
                                console.log('remove-row', e);
                            });
                            done();
                        });
                    });

                    it('should add/remove input rows', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Add/Remove Rows'})}, body);
                        const data = getInputData();
                        const items = data.items.slice(0, 1);
                        const node = dom('data-table', {
                            schema: data.schema,
                            rows: items,
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('change', function (e) {
                                console.log('change', e.value);
                            });
                            node.on('add-row', function (e) {
                                console.log('change', e);
                                delete e.value.added;
                                items.splice(e.value.index, 0, e.value);
                                node.rows = items;
                            });
                            node.on('remove-row', function (e) {
                                console.log('remove-row', e);
                                items.splice(e.value.index, 1);
                                node.rows = items;
                            });
                            done();
                        });
                    });

                    it('should format data', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Add/Remove Rows'})}, body);
                        const data = getInputData();
                        const items = data.items;
                        const schema = data.schema;
                        schema.columns[0].component.format = 'accounting';
                        schema.columns[1].component.format = 'accounting';
                        const node = dom('data-table', {
                            schema: schema,
                            rows: items,
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            done();
                        });
                    });

                    it('should add/remove with an actionbutton', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Add/Remove ActionButton'})}, body);
                        const data = getInputData();
                        const schema = data.schema;
                        schema.columns[schema.columns.length - 1].component.options = [
                            {value: 'add', label: 'Add Row'},
                            {value: 'edit', label: 'Edit Row'},
                            {value: 'remove', label: 'Remove Row'},
                        ]
                        console.log('schema', schema);
                        const items = data.items.slice(0, 2);
                        const node = dom('data-table', {
                            schema,
                            rows: items,
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('change', function (e) {
                                console.log('change', e);
                            });
                            node.on('add-row', function (e) {
                                console.log('change', e);
                                delete e.value.added;
                                items.splice(e.value.index, 0, e.value);
                                node.rows = items;
                            });
                            node.on('remove-row', function (e) {
                                console.log('remove-row', e);
                                items.splice(e.value.index, 1);
                                node.rows = items;
                            });
                            done();
                        });
                    });

                    it('should format data', function (done) {
                        const data = getData3();
                        const section = dom('section', {html: dom('label', {html: 'New Schema + Components'})}, body);
                        const node = dom('data-table', {
                            schema: data.schema,
                            rows: data.items,
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('change', function (e) {
                                console.log('change', e);
                            });
                            done();
                        });
                    });

                    it('should start from empty', function (done) {
                        const data = getData3();
                        const section = dom('section', {html: dom('label', {html: 'New Schema + Components'})}, body);
                        const node = dom('data-table', {
                            schema: data.schema,
                            rows: data.items,
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('change', function (e) {
                                console.log('change', e);
                            });
                            done();
                        });
                    });

                    it('should be format-able', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Formatable Inputs'})}, body);
                        const data = getFormatData();
                        const node = dom('data-table', {
                            schema: data.schema,
                            rows: data.items,
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('change', function (e) {
                                console.log('change', e);
                            });
                            done();
                        });
                    });

                    it('should be dynamically formatable', function (done) {
                        const data = getDataDyn();
                        const section = dom('section', {html: dom('label', {html: 'Dynamic Format'})}, body);
                        const node = dom('data-table', {
                            schema: data.schema,
                            rows: data.items,
                            sortable: true
                        }, section);
                        onDomReady(node, function () {
                            done();
                        });
                    });
                });

                describe('expandable', () => {
                    it('should expand rows', (done) => {
                        const data = getGeneralData();
                        const section = dom('section', {html: dom('label', {html: 'Expandable Rows'})}, body);
                        const node = dom('data-table', {
                            schema: data.schemaExpandable,
                            rows: data.items,
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('expanded', function (e) {
                                console.log('expanded', e.detail);
                            });
                            done();
                        });
                    });
                });

                describe('grouping', () => {
                    it.only('should group inline data', (done) => {
                        const section = dom('section', {html: dom('label', {html: 'Group Child Data'})}, body);
                        const node = dom('data-table', {
                            schema: groupedSchema,
                            rows: groupedItems,
                            zebra: true
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('change', function (e) {
                                console.log('change', e);
                            });
                            node.on('remove-row', function (e) {
                                console.log('remove-row', e);
                            });
                            done();
                        });
                    });
                });

                describe('rendering', function () {
                    it('should render a table', function (done) {
                        const data = getData3();
                        const section = dom('section', {html: dom('label', {html: 'Non Selectable Item'})}, body);
                        const node = dom('data-table', {
                            schema: data.schema,
                            rows: data.items
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            done();
                        });
                    });

                    it('should handle "no data"', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Data is NULL'})}, body);
                        const node = dom('data-table', {
                            rows: [],
                            schema: {}
                        }, section);
                        onDomReady(node, function () {
                            expect(node.classList.contains('no-data')).to.equal(true);
                            done();
                        });
                    });

                    it('should handle "no items"', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Items are []'})}, body);
                        const node = dom('data-table', {
                            schema: dataNoItems.schema,
                            rows: dataNoItems.items
                        }, section);
                        onDomReady(node, function () {
                            expect(node.classList.contains('no-data')).to.equal(true);
                            done();
                        });
                    });
                });

                describe('clickable', function () {
                    it('should have clickable rows', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Clickable Rows'})}, body);
                        const data = getGeneralData();
                        const node = dom('data-table', {
                            schema: data.schema,
                            rows: data.items,
                            clickable: true
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('row-click', function (e) {
                                console.log('click', e);
                            });
                            node.on('header-click', function (e) {
                                console.log('click', e);
                            });
                            done();
                        });
                    });
                });

                describe('scrolling', function () {

                    it('should be scrollable with minimal columns', function (done) {
                        const data = copy(getData());
                        data.columns = data.columns.slice(0, 4);
                        console.log('data.columns', data.columns);
                        const section = dom('section', {class: 'sized', html: 'Scrollable Stretchy'}, body);
                        const node = dom('data-table', {
                            schema: {columns: data.columns},
                            rows: data.items,
                            scrollable: true,
                            zebra: true,
                        }, section);
                        onDomReady(node, function () {
                            done();
                        });
                    });

                    it('should be scrollable', function (done) {
                        const data = getData();
                        const section = dom('section', {class: 'sized', html: 'Scrollable'}, body);
                        const node = dom('data-table', {
                            schema: {columns: data.columns},
                            rows: data.items,
                            scrollable: true
                        }, section);
                        onDomReady(node, function () {
                            done();
                        });
                    });

                    it('should be scrollable with maxHeight set FIXME', function (done) {
                        const data = getData();
                        const section = dom('section', {html: 'Scrollable, Max Height'}, body);
                        const node = dom('data-table', {
                            schema: {columns: data.columns},
                            rows: data.items,
                            scrollable: true,
                            'max-height': 200
                        }, section);
                        onDomReady(node, function () {
                            done();
                        });
                    });
                });

                describe('sorting', function () {
                    it('should sort', function (done) {
                        const section = dom('section', {html: dom('label', {html: 'Sortable 1'})}, body);
                        const data = getGeneralData();
                        const node = dom('data-table', {
                            schema: data.schema,
                            rows: data.items,
                            footer: dom('div', {html: 'select one of two rows'})
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('sort', function (e) {
                                //console.log('sort.event', e);
                                events.push(e.detail.value);
                            });

                            // expect(selectedColumn(node)).to.equal('weight');
                            // expect(getColData(node, 'weight')).to.equal('220,170,90');
                            // clickCol(node, 'weight');
                            // expect(getColData(node, 'weight')).to.equal('90,170,220');

                            // // reset to default sort
                            // clickCol(node, 'weight');
                            // expect(getColData(node, 'weight')).to.equal('170,90,220');
                            // expect(selectedColumn(node)).to.equal(null);

                            // clickCol(node, 'age');
                            // expect(selectedColumn(node)).to.equal('age');
                            // expect(getColData(node, 'age')).to.equal('40,20,10');

                            // clickCol(node, 'bp');
                            // expect(selectedColumn(node)).to.equal('bp');
                            // expect(getColData(node, 'bp')).to.equal('150,120,100');

                            // node.sort = 'height,desc';
                            // expect(selectedColumn(node)).to.equal('height');
                            // expect(getColData(node, 'height')).to.equal('6.1,5.9,4.5');


                            // node.sort = 'age';
                            // expect(selectedColumn(node)).to.equal('age');
                            // expect(getColData(node, 'age')).to.equal('40,20,10');

                            // node.sort = null;

                            // expect(events.join(';')).to.equal('weight,asc;weight,;age,desc;bp,desc;height,desc;age,desc;');

                            // destroy(node);
                            done();
                        });
                    });

                    it('should server-based sort', function (done) {

                        const extsort = {
                            field: 'age',
                            dir: 'desc'
                        };
                        const data = getGeneralData();
                        const section = dom('section', {html: dom('label', {html: 'Server Sortable onSort'})}, body);
                        const node = dom('data-table', {
                            schema: data.schema,
                            rows: data.items,
                            extsort,
                            // serversort: true,
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('sort', function (e) {
                                console.log('sort.event', e.detail);
                                const update = {
                                    field: e.detail.field,
                                    dir: e.detail.dir
                                };

                                setTimeout(() => {
                                    node.extsort = update;
                                }, 400);
                                events.push(e.detail.value);
                            });
                            done();
                        });
                    });

                    it('should dual-sort (server-based)', function (done) {
                        const extsort = {
                            field: ['name', 'age'],
                            dir: 'desc'
                        };
                        const data = getGeneralData();
                        const schema = {
                            columns: data.schemaDualSort.columns
                        };
                        const section = dom('section', {html: dom('label', {html: 'Server Sortable onSort'})}, body);
                        const node = dom('data-table', {
                            schema,
                            rows: data.items,
                            extsort,
                            // serversort: true,
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('sort', function (e) {
                                console.log('sort.event', e.detail);
                                const update = {
                                    field: e.detail.field,
                                    dir: e.detail.dir
                                };

                                setTimeout(() => {
                                    console.log('update', update);
                                    node.extsort = update;
                                }, 400);
                                events.push(e.detail.value);
                            });
                            done();
                        });
                    });
                });

                describe('selecting', function () {
                    it('should be selectable', function (done) {
                        const data = getGeneralData();
                        const section = dom('section', {html: dom('label', {html: 'Selectable'})}, body);
                        const node = dom('data-table', {
                            schema: data.schema,
                            rows: data.items,
                            selectable: true
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            node.on('change', function (e) {
                                console.log('chn', e);
                                events.push(e.value);
                            });
                            clickRow(node, 1);
                            expect(getSelectedRowId(node)).to.equal('1');
                            clickRow(node, 0);
                            expect(getSelectedRowId(node)).to.equal('3');
                            clickRow(node, 2);
                            expect(getSelectedRowId(node)).to.equal('2');
                            // deselect
                            clickRow(node, 2);
                            expect(getSelectedRowId(node)).to.equal(null);
                            expect(events.join(',')).to.equal('1,3,2,'); // last one is blank
                            destroy(node);

                            node.selected = 1;
                            expect(getSelectedRowId(node)).to.equal('1');

                            // test getter
                            expect(node.selected).to.equal(1);

                            node.selected = null;
                            expect(getSelectedRowId(node)).to.equal(null);

                            done();
                        });
                    });

                    it('should select first row and update', function (done) {
                        const data = getGeneralData();
                        const section = dom('section', {html: dom('label', {html: 'Selectable'})}, body);
                        const node = dom('data-table', {
                            schema: data.schema,
                            rows: data.items,
                            selectable: true,
                            autoselect: true
                        }, section);
                        onDomReady(node, function () {
                            node.on('change', function (e) {
                                console.log('chn', e);
                            });
                            console.log('ready');

                            setTimeout(() => {
                                // node.selected = null;
                                node.update = {
                                    id: 3,
                                    name: 'Monkey',
                                    age: 40,
                                    height: 5.9,
                                    weight: 220,
                                    bp: 30
                                }
                            }, 500);
                            done();
                        });
                    });

                    // it('should handle non-selectable items', function (done) {

                    // currently broken - looking to set unselectable to the css of a row

                    //     const section = dom('section', {html: dom('label', {html: 'Non Selectable Item'})}, body);
                    //     const node = dom('data-table', {
                    //         schema: data.schema,
                    //         rows: data.items,
                    //         selectable: true,
                    //     }, section);
                    //     const events = [];
                    //     onDomReady(node, function () {

                    //         clickRow(node, 1);
                    //         expect(getSelectedRowId(node)).to.equal('4');

                    //         clickRow(node, 0);
                    //         expect(getSelectedRowId(node)).to.equal(null);

                    //         done();
                    //     });
                    // });
                });

                describe('sort and select', function () {
                    it('should sort and select', function (done) {
                        const data = getGeneralData();
                        const section = dom('section', {html: dom('label', {html: 'Sortable and Selectable'})}, body);
                        const node = dom('data-table', {
                            schema: data.schema,
                            rows: data.items,
                            selectable: true
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            clickCol(node, 'weight');
                            expect(getColData(node, 'weight')).to.equal('90,170,220');

                            clickRow(node, 1);
                            expect(getSelectedRowId(node)).to.equal('1');

                            expect(getSelectedRowIdIndex(node)).to.equal(2);

                            clickCol(node, 'height');
                            expect(getSelectedRowId(node)).to.equal('1');
                            expect(getSelectedRowIdIndex(node)).to.equal(1);

                            done();
                        });
                    });

                    it('should maintain sort and select after new items', function (done) {
                        const data = getGeneralData();
                        const section = dom('section', {html: dom('label', {html: 'Sortable and Selectable'})}, body);
                        const node = dom('data-table', {
                            schema: data.schema,
                            rows: data.items,
                            sortable: true,
                            selectable: true
                        }, section);
                        const events = [];
                        onDomReady(node, function () {
                            clickCol(node, 'weight');
                            expect(getColData(node, 'weight')).to.equal('90,170,220');

                            clickRow(node, 1);
                            expect(getSelectedRowId(node)).to.equal('1');

                            expect(getSelectedRowIdIndex(node)).to.equal(2);

                            clickCol(node, 'height');
                            expect(getSelectedRowId(node)).to.equal('1');
                            expect(getSelectedRowIdIndex(node)).to.equal(1);

                            node.data = {};

                            expect(selectedColumn(node)).to.equal('height');
                            expect(getSelectedRowId(node)).to.equal('1');
                            expect(getSelectedRowIdIndex(node)).to.equal(1);

                            done();
                        });
                    });
                });

            });

        });

        dataNoItems = {
            schema: {
                columns: [
                    {key: 'name', label: 'Name'},
                    {key: 'age', label: 'Age'},
                    {key: 'height', label: 'Height'},
                    {key: 'weight', label: 'Weight'},
                    {key: 'bp', label: 'Blood Pressure', unsortable: true, format: 'percentage'},
                ],
            },
            items: []
        };

        function selectedColumn(node) {
            const th = dom.query(node, '.desc,.asc');
            if (!th) {
                return null;
            }
            return dom.attr(th, 'data-field');
        }

        function clickCol(node, field) {
            const th = dom.query(node, '[data-field="' + field + '"]');
            if (!th) {
                console.warn('th not found', field);
                return null
            }
            on.emit(th, 'click');
        }

        function clickRow(node, index) {
            const row = node.tbody.rows[index];
            on.emit(row, 'click');
        }

        function getSelectedRowId(node) {
            const tr = dom.query(node, '.selected');
            return tr ? dom.attr(tr, 'data-row-id') : null;
        }

        function getSelectedRowIdIndex(node) {
            const tr = dom.query(node, '.selected');
            return (tr || {rowIndex: null}).rowIndex;
        }

        function getColData(node, field) {
            const cells = dom.queryAll(node, 'tbody [data-field="' + field + '"]');
            return cells.map(function (cell) {
                return cell.textContent;
            }).join(',');
        }

        function copy(data) {
            return JSON.parse(JSON.stringify(data));
        }

        function destroy(node) {
            //node.destroy();
        }

        window.mocha.run();


    </script>
</body>

</html>